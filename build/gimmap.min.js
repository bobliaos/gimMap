var GIM={VERSION:"0.0.1",INFO:" *** Author:bob / http://bobliaos.diandian.com / FOR LOVE AND PEACE ***",_map:null,_mapInstance:null,set mapInstance(a){throw new Error("THE MAP INSTANCE CAN'T BE SET!!!")},get mapInstance(){return null===this._mapInstance&&(console.log("- [GimMap]GIM.VERSION:",this.VERSION,this.INFO),this._mapInstance=document.createElement("div"),this._mapInstance.style.cssText="width: 1040px;height: 1440px;overflow: hidden;position: absolute;background:#888888",this._map=new GIM.Map3D(this._mapInstance)),this._mapInstance},goDetail:function(){},navitateTo:function(){},setSize:function(a,b){this._map.setSize(a,b)}};GIM.NODE_TYPE_ASTAR="0",GIM.NODE_TYPE_GROUND="1",GIM.NODE_TYPE_SHOP="2",GIM.NODE_TYPE_MACHINE="3",GIM.NODE_TYPE_ESCALATOR="4",GIM.NODE_TYPE_LIFT="5",GIM.NODE_TYPE_STAIRS="6",GIM.NODE_TYPE_TOILET="7",GIM.NODE_TYPE_SERVICE="8",GIM.NODE_TYPE_ATM="9",GIM.SERVER="http://192.168.1.208:3000",GIM.MACHINE_NODE_ID="node_2014_8_13_01:18:25_578",GIM.FLOOR_GAP=700,GIM.PATH_POINT_GAP=8,GIM.PATH_COLOR=16711680,GIM.MAP_OFFSET_Y=200,GIM.MAP_BACKGROUND_COLOR=14540253,GIM.SELECTED_COLOR=16759552,GIM.FONT_NAME="Microsoft Yahei",GIM.SHADOW_MAP_SIZE=2048,GIM.CONFIG_URL="map.conf",GIM.DATA_SOURCE_URL="assets/data.json",GIM.SHOP_LIST_URL="assets/shoplist.json",GIM.DEFAULT_SHOP_LOGO_URL="assets/img/shoplogo/0.png",GIM.FloorLogos=function(a){var b={pin:doucment.createElement("canvas")};return pin.width=300,pin.height=300,pin.style.cssText="width:"+pin.width+"px;height:"+pin.height+"px;position:absolute;",pin.id="pinCanvas",a.appendChild(b.pin),b},GIM.MapPin=function(a){var b={width:180,height:160,pinRadius:42,maxRadius:88,container:document.createElement("div"),menuCanvas:document.createElement("canvas"),pinCanvas:document.createElement("canvas"),logoCanvas:document.createElement("canvas"),logoImage:new Image,gotoImage:new Image,searchImage:new Image,init:function(){this.container.appendChild(this.menuCanvas),this.container.appendChild(this.pinCanvas),this.container.appendChild(this.logoCanvas),this.container.appendChild(this.gotoImage),this.container.appendChild(this.searchImage),a.appendChild(this.container),this.container.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;display:none;",this.menuCanvas.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;",this.menuCanvas.width=this.width,this.menuCanvas.height=this.height,this.pinCanvas.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;",this.pinCanvas.width=this.width,this.pinCanvas.height=this.height,this.logoCanvas.width=90,this.logoCanvas.height=90,this.logoCanvas.cssText="width:82px;height:82px",this.pinCanvas.id="pinCanvas",this.logoCanvas.id="logoCanvas",this.gotoImage.id="gotoImage",this.searchImage.id="searchImage",this.logoImage.bindPin=this,this.logoImage.onload=function(a){var b=.5*(this.bindPin.width-a.currentTarget.naturalWidth),c=.5*(this.bindPin.height-a.currentTarget.naturalHeight);this.bindPin.logoCanvas.style.cssText="width:90px;height:90px;position:absolute;top:"+c+"px;left:"+b+"px;display:block",this.bindPin.updateDisplay()},this.gotoImage.src="assets/img/mappin/goto.png",this.gotoImage.style.cssText="top: 20px;position: absolute;left: 96px;",this.searchImage.src="assets/img/mappin/search.png",this.searchImage.style.cssText="top: 56px;position: absolute;left: 132px;"},_isOpenning:!1,open:function(a,b,c){this._isOpenning=!0,""===c&&(c=GIM.DEFAULT_SHOP_LOGO_URL),this.logoImage.src=c,console.log("- [GimMap]MapPin.open:",c,this.logoImage.src),this.container.style.display="block",this.container.style.left=a-.5*this.width+"px",this.container.style.top=b-this.height+"px",TWEEN.remove(this),TWEEN.remove(this.gotoImage.style),TWEEN.remove(this.searchImage.style),this.radius=10,this.alpha=.3,this.rotation=0,this.gotoImage.style.display=this.searchImage.style.display="none",this.gotoImage.style.opacity=this.searchImage.style.opacity=0,new TWEEN.Tween(this).to({alpha:1,rotation:0,radius:this.maxRadius},30).easing(TWEEN.Easing.Elastic.Out).onComplete(function(){this.gotoImage.style.opacity=this.searchImage.style.opacity=0,this.gotoImage.style.display=this.searchImage.style.display="block",new TWEEN.Tween(this.gotoImage.style).to({opacity:1},200).start(),new TWEEN.Tween(this.searchImage.style).to({opacity:1},200).start()}).start()},close:function(){this._isOpenning=!1,this.logoImage.src="",this.logoCanvas.style.display="none",this.gotoImage.style.opacity=this.searchImage.style.opacity=0,new TWEEN.Tween(this).to({alpha:0,rotation:0,radius:10},20).easing(TWEEN.Easing.Back.In).onComplete(function(){this._isOpenning||(this.container.style.display="none")}).start()},_radius:100,set radius(a){this._radius=a>this.maxRadius?this.maxRadius:a,this.updateDisplay()},get radius(){return this._radius},_rotation:0,set rotation(a){this._rotation=a,this.updateDisplay()},get rotation(){return this._rotation},_alpha:0,set alpha(a){this._alpha=a,this.updateDisplay()},get alpha(){return this._alpha},updateDisplay:function(){var a=this.menuCanvas.getContext("2d"),b=this.pinCanvas.getContext("2d"),c=this.logoCanvas.getContext("2d");a.clearRect(0,0,this.width,this.height),b.clearRect(0,0,this.width,this.height),c.clearRect(0,0,this.width,this.height);var d=this._radius>this.maxRadius?this.maxRadius:this._radius;d=0>d?0:d,b.strokeStyle="#2d3540",b.lineWidth=2,b.fillStyle="#2d3540",b.lineCap="round",b.beginPath();var e=.5*this.width,f=this.height-this._radius+20;f<.5*this.height+20&&(f=.5*this.height+20);var g=this.height-b.lineWidth-4,h=d>this.pinRadius?this.pinRadius:d;if(b.moveTo(e,g),b.arc(e,f,h,.54*Math.PI,.46*Math.PI),b.lineTo(e,g),b.stroke(),b.fill(),b.closePath(),d>this.pinRadius+10){a.strokeStyle="#FFFFFF",a.lineWidth=4,a.fillStyle="#cc1847";var i=.5*this.width,j=.5*this.height+20;a.beginPath(),a.moveTo(i,j),a.arc(i,j,d,.5*-Math.PI,.254*-Math.PI),a.lineTo(i,j),a.closePath(),a.stroke(),a.fill(),a.fillStyle="#2d3540",a.beginPath(),a.moveTo(i,j),a.arc(i,j,d,.246*-Math.PI,0),a.lineTo(i,j),a.closePath(),a.stroke(),a.fill()}var k=1;this.pinRadius>this._radius&&(k=this._radius/this.pinRadius);try{this.logoCanvas.style.top=f-this.pinRadius*k+this.pinRadius-.5*this.logoImage.height+1.5+"px";var l=(d>this.pinRadius?this.pinRadius:d)-3;0>l&&(l=0),c.beginPath(),c.arc(.5*this.logoImage.width,l,l,0*Math.PI,2*Math.PI);var m=c.createPattern(this.logoImage,"no-repeat");c.fillStyle=m,c.fill(),c.closePath()}catch(n){console.log("- [GimMap]MapPin Load Image Error!"),this.logoImage.src=GIM.DEFAULT_SHOP_LOGO_URL}}};return b.init(),b},GIM.ServiceLogo=function(a,b,c){var d={onTime:1e3,index:-1,path:"assets/img/servicelogo/",logoOnURL:"",logoOffURL:"",logoDisableURL:"",width:180,height:160,container:document.createElement("div"),logoImage:new Image,logoText:document.createElement("div"),init:function(){this.index=b,this.logoOnURL=this.path+b+".png",this.logoOffURL=this.path+b+"_.png",this.logoDisableURL=this.path+b+"__.png",this.container.appendChild(this.logoImage),this.container.appendChild(this.logoText),a.appendChild(this.container),this.logoImage.style.cssText="",this.logoText.style.cssText="color:#444444;font-size:18px;font-family:Microsoft Yahei;margin-top:12px;",this.container.style.cssText="width:100px;height:100px;margin-left: 0px;float:left",this.logoText.innerHTML=c,this._isReady=!0,this.updateDisplay()},_isReady:!1,_logoOn:!1,set logoOn(a){this._logoOn=a,this.updateDisplay()},get logoOn(){return this._logoOn},_disable:!1,set disable(a){this._disable=a,this.updateDisplay()},get disable(){return this._disable},updateDisplay:function(){this._isReady&&(this.logoImage.src=this._disable?this.logoDisableURL:this._logoOn?this.logoOnURL:this.logoOffURL,this.logoText.style.color=this._disable?"#888888":this._logoOn?"#FF0033":"#222244")},onClickHandler:function(){}};return d.init(),d.container.addEventListener("click",function(){d._disable||d.onClickHandler(d.index.toString()),d.logoOn=!0,setTimeout(function(){d.logoOn=!1},d.onTime)}),d},GIM.ZoomBar=function(a){var b={width:180,height:160,container:document.createElement("div"),plus:document.createElement("canvas"),minus:document.createElement("canvas"),rail:document.createElement("canvas"),thumb:document.createElement("canvas"),init:function(){this.container.appendChild(this.rail),this.container.appendChild(this.plus),this.container.appendChild(this.minus),this.container.appendChild(this.thumb),a.appendChild(this.container),this.container.style.cssText="position: absolute;top: 460px;right: 20px;visibility:hidden",this.plus.style.cssText="width: 80px;height: 80px;background: #99CC33;position: absolute;bottom: 0px;left: 0px;",this.minus.style.cssText="width: 80px;height: 80px;background: #99CC33;position: absolute;bottom: 0px;left: 0px;",this.rail.style.cssText="background: #0099CC;width: 80px;height: 400px;position: absolute;left: 0px;top: 0px",this.thumb.style.cssText=""},updateDisplay:function(){}};return b.init(),b},GIM.FloorData=function(a){for(var b={origSVG:a,floorId:a.getAttribute("id"),unitsData:{}},c=a.getElementsByTagName("path"),d=0;d<c.length;d++){var e=c[d],f=new GIM.UnitData(e);f.floorId=b.floorId,b.unitsData[f.nodeId]=f}return b},GIM.SVGParser={loadURL:function(a,b){$.getJSON(a,function(a){"undefined"!=typeof b&&b(a)})},getSVGObject:function(a){var b=new DOMParser;return b.parseFromString(a,"text/xml")},parse:function(a){function b(){for(var b,c,d,k=!1;q>p&&(c=a.charCodeAt(p),c===g||c===h);)p++;for(b=c===j?p++:p;q>p;)if(c=a.charCodeAt(p),c>=e&&f>=c)p++;else{if(c!==i){d=a.substring(b,p);break}p++,k=!0}return k?parseFloat(d):parseInt(d)}function c(){for(var b;q>p&&(b=a.charCodeAt(p),b===g||b===h);)p++;return b=a.charCodeAt(p),b===j||b>=e&&f>=b}const d=Math.PI/180,e=48,f=57,g=44,h=32,i=46,j=45;var k,l,m,n,o=new THREE.Shape,p=1,q=a.length,r=0,s=0,t=0,u=0,v=null,w=null,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0;for(k=a[0];q>=p;){switch(n=!0,k){case"M":r=b(),s=b(),o.moveTo(r,-s),k="L",v=r,w=s;break;case"m":r+=b(),s+=b(),o.moveTo(r,-s),k="L",v=r,w=s;break;case"Z":break;case"z":n=!1,(r!==v||s!==w)&&o.lineTo(v,-w);break;case"L":case"H":case"V":t="V"===k?r:b(),u="H"===k?s:b(),o.lineTo(t,-u),r=t,s=u;break;case"l":case"h":case"v":t="v"===k?r:r+b(),u="h"===k?s:s+b(),o.lineTo(t,-u),r=t,s=u;break;case"C":x=b(),z=b();case"S":"S"===k&&(x=2*r-y,z=2*s-A),y=b(),A=b(),t=b(),u=b(),o.bezierCurveTo(x,-z,y,-A,t,-u),r=t,s=u;break;case"c":x=r+b(),z=s+b();case"s":"s"===k&&(x=2*r-y,z=2*s-A),y=r+b(),A=s+b(),t=r+b(),u=s+b(),o.bezierCurveTo(x,-z,y,-A,t,-u),r=t,s=u;break;case"Q":x=b(),z=b();case"T":"T"===k&&(x=2*r-x,z=2*s-z),t=b(),u=b(),o.quadraticCurveTo(x,-z,t,-u),r=t,s=u;break;case"q":x=r+b(),z=s+b();case"t":"t"===k&&(x=2*r-x,z=2*s-z),t=r+b(),u=s+b(),o.quadraticCurveTo(x,-z,t,-u),r=t,s=u;break;case"A":B=b(),C=b(),D=b()*d,E=b(),F=b(),t=b(),u=b(),x=Math.cos(D)*(r-t)/2+Math.sin(D)*(s-u)/2,z=-Math.sin(D)*(r-t)/2+Math.cos(D)*(s-u)/2;var G=Math.sqrt((B*B*C*C-B*B*z*z-C*C*x*x)/(B*B*z*z+C*C*x*x));E===F&&(G=-G),y=G*B*z/C,A=G*-C*x/B,l=Math.cos(D)*y-Math.sin(D)*A+(r+t)/2,m=Math.sin(D)*y-Math.cos(D)*A+(s+u)/2;var H=new THREE.Vector2(1,0),I=new THREE.Vector2((x-y)/B,(z-A)/C),J=Math.acos(H.dot(I)/H.length()/I.length());H.x*I.y-H.y*I.x<0&&(J=-J),H.x=(-x-y)/B,H.y=(-z-A)/C;var K=Math.acos(I.dot(H)/I.length()/H.length());I.x*H.y-I.y*H.x<0&&(K=-K),!F&&K>0&&(K-=2*Math.PI),F&&0>K&&(K+=2*Math.PI),o.absarc(l,-m,B,J,J+K,F),r=t,s=u;break;default:console.log(">>>"+k+"<<<")}n&&c()||(k=a[p++])}return o}},GIM.UnitData=function(a){var b={origSVG:a,nodeId:a.getAttribute("nodeId"),nodeTypeId:a.getAttribute("nodeTypeId"),bindNodeIds:a.getAttribute("bindNodeIds"),bindShopId:a.getAttribute("bindShopId"),d:a.getAttribute("d"),fill:a.getAttribute("fill"),deep:a.getAttribute("deep"),floorId:null,shopName:"",origZ:0},c=a.getAttribute("nodePosition").split(",");b.nodePosition={x:parseFloat(c[0]),y:parseFloat(c[1])},b.selectable=!0,b.astarNode=new GIM.AStarNode(b);for(var d=0;d<GIM.shopList.length;d++){var e=GIM.shopList[d];if(e.shop_room===b.bindShopId){b.shopName=e.name;break}}return b},GIM.AStar={search:function(a,b,c){function d(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}for(var e in a){var f=a[e];f.f=0,f.g=0,f.h=0,f.closed=!1,f.parent=null}var g=a[b],h=a[c];if(g&&h){var i=[],j=[];for(i.push(g);i.length>0;){var k=i.pop();if(j.push(k),k===h)break;for(var l=0;l<k.bindNodes.length;l++){var m=k.bindNodes[l];j.indexOf(m)<0&&(m.g=d(g,h),m.h=d(m,h),m.f=m.g+m.h,m.parent=k,i.push(m))}i.sort(function(a,b){return a.f<b.f})}}for(var n=[],o=j.pop();o;)n.push(o),o=o.parent;return n}},GIM.AStarGraph=function(){this.nodes=[]},GIM.AStarNode=function(a){return{id:a.nodeId,data:a,x:a.nodePosition.x,y:a.nodePosition.y,f:0,g:0,h:0,parent:null,bindNodes:[]}},GIM.DisplayFloor3D=function(a){this.data=new GIM.FloorData(a),this.subUnit3Ds={},this.mesh=new THREE.Object3D,this.mesh.displayUnit3D=this,console.log("- [GimMap]DisplayFloor3D.constructor:",this.data.floorId,"CONSTRUCTING...");for(var b in this.data.unitsData){var c=this.data.unitsData[b],d=new GIM.DisplayUnit3D(c);d.mesh&&this.mesh.add(d.mesh),this.subUnit3Ds[c.nodeId]=d}return this},GIM.DisplayUnit3D=function(a){function b(){var b=GIM.SVGParser.parse(a.d),c=b.toShapes(!0)[0].extrude({amount:1*a.deep,bevelEnabled:!1}),d=new THREE.Color(a.fill),e=new THREE.MeshLambertMaterial({color:d,ambient:d,emissive:d});f=new THREE.Mesh(c,e)}function c(b,c,d){var d=void 0===d?c?60:80:d,e=new THREE.PlaneGeometry(d,d,1,1),h=THREE.ImageUtils.loadTexture(b),i=new THREE.MeshBasicMaterial({map:h,transparent:!0}),j=new THREE.Mesh(e,i);j.isServiceLogo=c,f?f.add(j):f=j,j.castShadow=!0,j.receiveShadow=!0,j.position.x=a.nodePosition.x,j.position.y=-a.nodePosition.y+(c?0:.5*d)+(d>100?20:0),j.position.z=parseInt(a.deep)+g,j.rotation.x=.25*Math.PI,c&&(a.origZ=.5*d+20,j.position.z=a.origZ)}function d(b,c,d){if(""!=b){void 0===c&&(c=0),void 0===d&&(d=18);var e=d+"px "+GIM.FONT_NAME,h=document.createElement("canvas"),i=h.getContext("2d");i.font=e,h.width=i.measureText(b).width+2,h.height=24,h.style.cssText="width:"+h.width+"px;height:"+h.height+"px;background:#FF0000;margin:2px;",i.font=e,i.fillStyle="#000",i.fillText(b,1,h.height-6);var j=new THREE.PlaneGeometry(h.width,h.height,1,1),k=new THREE.Texture(h);k.needsUpdate=!0;var l=new THREE.MeshBasicMaterial({map:k,transparent:!0}),m=new THREE.Mesh(j,l);m.position.x=a.nodePosition.x,m.position.y=-a.nodePosition.y-c-.5*h.height,m.position.z=parseInt(a.deep)+g,f?f.add(m):f=m}}function e(){h.to({opacity:1},600).easing(TWEEN.Easing.Elastic.InOut).onComplete(function(){h.to({opacity:0},220).easing(TWEEN.Easing.Linear.None).onComplete(e).start()}).delay(600*Math.random()+300).start()}var f=null,g=10;switch(a.nodeTypeId){case GIM.NODE_TYPE_ASTAR:break;case GIM.NODE_TYPE_GROUND:b(),a.selectable=!1,f.position.z=-(1*a.deep+1);break;case GIM.NODE_TYPE_SHOP:b(),a.bindShopId&&(d(a.shopName),d(a.bindShopId,18,14));break;case GIM.NODE_TYPE_MACHINE:c("assets/img/nodetypelogo/machine_.png",!0,120);var h=new TWEEN.Tween(f.material);e();break;case GIM.NODE_TYPE_ESCALATOR:c("assets/img/nodetypelogo/escalator.png",!0);break;case GIM.NODE_TYPE_LIFT:c("assets/img/nodetypelogo/lift.png",!0);break;case GIM.NODE_TYPE_TOILET:c("assets/img/nodetypelogo/toilet.png",!0);break;case GIM.NODE_TYPE_SERVICE:c("assets/img/nodetypelogo/service.png",!0);break;case GIM.NODE_TYPE_ATM:c("assets/img/nodetypelogo/atm.png",!0)}return f&&(f.castShadow=!0,f.receiveShadow=!0,this.mesh=f,this.mesh.displayUnit3D=this),this.data=a,this},GIM.Map3D=function(a){function b(){console.log("- [GimMap]Map3D.reset"),db&&(h(),d([_[GIM.MACHINE_NODE_ID].data.floorId]))}function c(a){if(k(a),Z){console.log("- [GimMap]Map3D.navigateTo Shop",Z.data.bindShopId);var b=_[GIM.MACHINE_NODE_ID].data.floorId,c=Z.data.floorId;d(b===c?[b]:[b,c]);for(var g=[],h=GIM.AStar.search(_,GIM.MACHINE_NODE_ID,Z.data.nodeId),i=0;i<h.length;i++){var j=h[i],l=Y[j.data.floorId],m=new THREE.Vector3(j.x,j.y,l.mesh.position.z+5);g.push(m)}f(g),e(Z)}}function d(a){null===$&&($=a),M._isOpenning&&M.close(),console.log("- [GimMap]Map3D.showFloors:",a.toString());for(var b=0;b<ab.length;b++){var c=ab[b];c.selected=!1,a.indexOf(ab[b].id)>-1&&(c.selected=!0)}for(var d in Y){var e=Y[d];e.mesh.visible=!1,e.mesh.position.z=bb}if(1===a.length){if($.length>0){var f=$[0],g=a[0],h=Y[f],i=Y[g];if(i.mesh.visible=h.mesh.visible=!0,h!==i){var j=parseInt(f.substr(5,1))>parseInt(g.substr(5,1));h.mesh.position.z=0,i.mesh.position.z=j?bb:cb,new TWEEN.Tween(h.mesh.position).to({z:j?cb:bb},800).easing(TWEEN.Easing.Exponential.Out).start(),new TWEEN.Tween(i.mesh.position).to({z:0},800).easing(TWEEN.Easing.Exponential.Out).start()}else h.mesh.position.z=0}}else if(2===a.length){var k=Y[a[0]],l=Y[a[1]];k.mesh.visible=l.mesh.visible=!0;var j=parseInt(k.data.floorId.substr(5,1))>parseInt(l.data.floorId.substr(5,1));k.mesh.position.z=.5*GIM.FLOOR_GAP*(j?1:-1),l.mesh.position.z=.5*GIM.FLOOR_GAP*(j?-1:1)}$=a;for(var m=[],b=0;b<$.length;b++){var e=Y[$[b]];for(var n in e.subUnit3Ds){var o=e.subUnit3Ds[n],p=o.data.nodeTypeId;m.indexOf(p)<0&&m.push(p)}}for(var b=0;b<ib.length;b++){var q=ib[b];if(q.disable=m.indexOf(q.index)<0,q.index==GIM.NODE_TYPE_MACHINE){var r=_[GIM.MACHINE_NODE_ID].data.floorId;q.disable=-1==$.indexOf(r)}}}function e(a){if(null!==a){var b=o(a.data.nodePosition.x,-a.data.nodePosition.y,a.mesh.parent.position.z+parseInt(a.data.deep)+20);M.open(b.x,b.y,p(a.data.bindShopId))}}function f(a){a=j(a);for(var b,c=new THREE.Geometry,d=0;d<a.length;d++)b=a[d],c.vertices[d]=new THREE.Vector3(b.x,-b.y,b.z+15);L=new THREE.Line(c,new THREE.LineBasicMaterial({color:GIM.PATH_COLOR}));for(var d=0;d<c.vertices.length;d++){var e=c.vertices[d];if(!c.vertices[d+1]||c.vertices[d].z===c.vertices[d+1].z||d%2==0){var f=new THREE.CircleGeometry(6,8),g=new THREE.MeshBasicMaterial({color:GIM.PATH_COLOR}),h=new THREE.Mesh(f,g);I.add(h),h.visible=!1,eb.push(h),h.position.x=e.x,h.position.y=e.y,h.position.z=e.z}}hb=eb.length,fb=eb.length,I.add(L)}function g(){fb--,0>fb&&(fb=hb);for(var a=0;a<eb.length;a++){var b=eb[a];b.visible=a===fb}}function h(){for(L&&(L.parent.remove(L),L=null,delete L);eb.length>0;){var a=eb.pop();a&&(a.parent.remove(a),a=null,delete a)}}function i(a,b){console.log("- [GimMap]Map3D.setSize:",a,b),A=a,B=b,C=.5*A,D=.5*B,H.aspect=A/B,H.updateProjectionMatrix(),E.setSize(A,B)}function j(a){for(var b=[],c=null,d=0;d<a.length;d++){var e=a[d];if(c){b.push(c);var f=e.clone().sub(c),g=f.length();if(g>GIM.PATH_POINT_GAP)for(var h=parseInt(g/GIM.PATH_POINT_GAP),i=1;h>i;i++)b.push(f.clone().multiplyScalar(i/h).add(c))}c=e}return b}function k(a){n();for(var b in Y){var c=Y[b];for(var d in c.subUnit3Ds){var e=c.subUnit3Ds[d];if(a===e.data.bindShopId){console.log("- [GimMap]Map3D.selectUint3DByShopId:",a,"DONE!"),m(e);break}}}}function l(a,b){n(),a=2*a/A-1,b=1-2*b/B;var c=new THREE.Vector3(a,b,0);J.unprojectVector(c,H);var d=new THREE.Raycaster(H.position,c.sub(H.position).normalize()),e=d.intersectObjects(W);if(e.length>0){var f=e[0].object;f.displayUnit3D&&f.displayUnit3D.data.selectable&&(console.log("- [GimMap]Map3D.selectUnit3DByPosition",f.displayUnit3D.data.nodeId),m(f.displayUnit3D))}}function m(a){if(Z=a,a.mesh.isServiceLogo)new TWEEN.Tween(a.mesh.position).to({z:a.data.origZ+20},500).easing(TWEEN.Easing.Elastic.Out).start();else{jb=Z.mesh.material;var b=new THREE.Color(Z.data.fill),c=b.getHSL();b.setHSL(c.h,c.s+.3,c.l+.07),Z.mesh.material=new THREE.MeshLambertMaterial({color:b,ambient:b,emissive:b}),new TWEEN.Tween(a.mesh.scale).to({z:1.4,x:a.mesh.isServiceLogo?1.1:1,y:a.mesh.isServiceLogo?1.1:1},500).easing(TWEEN.Easing.Elastic.Out).start()}}function n(){for(var a=0;a<X.length;a++){var b=X[a];b.position.z!=b.displayUnit3D.data.origZ&&new TWEEN.Tween(b.position).to({z:b.displayUnit3D.data.origZ},500).easing(TWEEN.Easing.Elastic.Out).start()}if(null!==Z){if(null!==jb&&!Z.mesh.isServiceLogo){var c=Z.mesh.material;c=void 0,delete c,Z.mesh.material=jb}new TWEEN.Tween(Z.mesh.scale).to({z:1,x:1,y:1},500).easing(TWEEN.Easing.Elastic.Out).start(),Z=null}}function o(a,b,c){var d=new THREE.Projector,e=new THREE.Vector3(a+I.position.x,b,c),f=d.projectVector(e,H);return{x:Math.round(f.x*C+C),y:Math.round(-f.y*D+D)}}function p(a){var b="";if(GIM.shopList)for(var c=0;c<GIM.shopList.length;c++){var d=GIM.shopList[c];d.shop_room.toString()===a&&(console.log("- [GimMap]Map3D.getShopLogoURL:",a),b=GIM.SERVER+"/system"+d.shop_logo)}return b}function q(b){if(b.preventDefault(),a.addEventListener("mousemove",r,!1),a.addEventListener("mouseup",s,!1),a.addEventListener("mouseout",s,!1),h(),M.close(),"gotoImage"===b.target.id&&b.offsetY<M.width)Z&&(console.log("- [GimMap]Map3D.onContainerMouseDown ShopId:",Z.data.bindShopId),Z.data.nodeTypeId===GIM.NODE_TYPE_SHOP&&c(Z.data.bindShopId));else if("searchImage"===b.target.id)console.log("- [GimMap]Map3D.goDetail:",Z.data.bindShopId),GIM.goDetail(Z.data.bindShopId);else if(l(b.offsetX,b.offsetY),Z)if(Z.data.nodeTypeId===GIM.NODE_TYPE_SHOP)e(Z);else{console.log("- [GimMap]Map3D.navigateTo Shop",Z.data.bindShopId);var g=_[GIM.MACHINE_NODE_ID].data.floorId,i=Z.data.floorId;d(g===i?[g]:[g,i]);for(var j=[],k=GIM.AStar.search(_,GIM.MACHINE_NODE_ID,Z.data.nodeId),m=0;m<k.length;m++){var n=k[m],o=n.data.floorId,p=Y[o],q=new THREE.Vector3(n.x,n.y,p.mesh.position.z+5);j.push(q)}f(j)}}function r(a){U=a.clientX-C,S=T+.02*(U-V)}function s(){a.removeEventListener("mousemove",r,!1),a.removeEventListener("mouseup",s,!1),a.removeEventListener("mouseout",s,!1)}function t(){GIM.SVGParser.loadURL(GIM.SHOP_LIST_URL,function(d){GIM.shopList=d,GIM.navitateTo=c,GIM.setSize=i,u(),Q&&y(),z(),setInterval(g,gb),i(parseFloat(a.style.width),parseFloat(a.style.height)),a.addEventListener("mousedown",q,!1),a.addEventListener("DOMNodeInserted",b,!1)})}function u(){var b=1,c=1e4;R=0===GIM.SHADOW_MAP_SIZE,E=new THREE.WebGLRenderer({antialias:!0}),a.appendChild(E.domElement),E.setClearColor(GIM.MAP_BACKGROUND_COLOR),E.setSize(64,64),E.shadowMapEnabled=!0,E.shadowMapType=THREE.PCFShadowMap,G=new THREE.Scene,H=new THREE.PerspectiveCamera(60,1,b,c),I=new THREE.Object3D,G.add(I);var e=new THREE.DirectionalLight(16777215,.2);G.add(e),e.position.set(1400,-2200,2200),e.target.position.set(500,-300,0),e.castShadow=!0,e.shadowCameraNear=1800,e.shadowCameraFar=4500,e.shadowBias=1e-4,e.shadowDarkness=.6,e.shadowMapWidth=e.shadowMapHeight=GIM.SHADOW_MAP_SIZE,Q&&(e.shadowCameraVisible=!0);var f=new THREE.DirectionalLight(3355443,.8);if(G.add(f),f.position.set(400,500,500),Q){var g=new THREE.Mesh(new THREE.PlaneGeometry(5e3,5e3,50,50),new THREE.MeshBasicMaterial({color:15658734,wireframe:!0}));I.add(g)}J=new THREE.Projector,M=new GIM.MapPin(a),GIM.SVGParser.loadURL(GIM.DATA_SOURCE_URL,function(a){v(),K=GIM.SVGParser.getSVGObject(a);for(var b=K.getElementsByTagName("g"),c=b.length-1;c>=0;c--){var e=b[c],f=new GIM.DisplayFloor3D(e);Y[f.data.floorId]=f,I.add(f.mesh);var g=!1;for(var h in f.subUnit3Ds){var i=f.subUnit3Ds[h].mesh;i&&(W.push(i),i.isServiceLogo&&X.push(i),i.displayUnit3D.data.nodeTypeId===GIM.NODE_TYPE_MACHINE&&(i.displayUnit3D.data.nodeId===GIM.MACHINE_NODE_ID?g=!0:(i.position.x=-2e4,i.visible=!1)))}for(var h in f.data.unitsData){var j=f.data.unitsData[h];_[j.nodeId]=j.astarNode}x(f.data.floorId,"assets/img/floorlogo/"+f.data.floorId+".png",g)}for(var k in _){var l=_[k],m=l.data.bindNodeIds,n=m.split(",");for(var o in n){var p=n[o],q=_[p];q&&l.bindNodes.push(q)}}d([_[GIM.MACHINE_NODE_ID].data.floorId]),kb.setCamera(.25*Math.PI,1800,0),kb.posX=.5*parseFloat(K.getElementsByTagName("svg")[0].getAttribute("width"))-100,db=!0})}function v(){N=document.createElement("div"),a.appendChild(N),N.style.cssText="position:absolute;top:240px;left:0px;text-align:left;";var b=new Image,c=new Image;N.appendChild(b),N.appendChild(c),b.src="assets/img/up.png",c.src="assets/img/down.png",b.style.cssText=c.style.cssText="left: 60px;position: relative;",O=document.createElement("div"),a.appendChild(O),O.style.cssText="position:absolute;top:30px;left:230px";for(var d=[GIM.NODE_TYPE_MACHINE,GIM.NODE_TYPE_SERVICE,GIM.NODE_TYPE_ATM,GIM.NODE_TYPE_TOILET,GIM.NODE_TYPE_ESCALATOR,GIM.NODE_TYPE_LIFT],e=["我的位置","服务中心","ATM","洗手间","扶梯","升降梯"],f=0;f<d.length;f++){var g=d[f],h=e[f],i=new GIM.ServiceLogo(O,g,h);ib.push(i),i.onClickHandler=w}P=new GIM.ZoomBar(a)}function w(a){for(var b=0;b<$.length;b++){var c=Y[$[b]];for(var d in c.subUnit3Ds){var e=c.subUnit3Ds[d];e.data.nodeTypeId===a&&(e.mesh.material.opacity=0,e.mesh.scale.x=e.mesh.scale.y=1.2,new TWEEN.Tween(e.mesh.material).to({opacity:1},600).easing(TWEEN.Easing.Back.InOut).repeat(2).start(),new TWEEN.Tween(e.mesh.scale).to({x:1,y:1},600).easing(TWEEN.Easing.Elastic.InOut).repeat(2).start())}}}function x(a,b,c){var e={id:a,width:170,height:112,container:document.createElement("div"),floorLabel:document.createElement("p"),floorCurLabel:document.createElement("p"),floorLogoImage:new Image,_selected:!1,set selected(a){this._selected=a,this.container.style.opacity=a?1:.4,this.container.style.color=a?"#FF0033":"#222222",this.floorCurLabel.style.display=a?"block":"none",TWEEN.remove(this),new TWEEN.Tween(this).to({scale:a?1.2:1},300).easing(TWEEN.Easing.Exponential.Out).start()},get selected(){return this._selected},_scale:1,set scale(a){this._scale=a,this.container.style.height=this.height*a+"px",this.container.style.width=this.width*a+"px"},get scale(){return this._scale}};N.insertBefore(e.container,N.lastChild),ab.push(e),e.container.appendChild(e.floorLogoImage),e.container.appendChild(e.floorLabel),e.container.appendChild(e.floorCurLabel),e.container.style.cssText="position:relative;height:"+e.height+"px;width:"+e.width+"px;opacity:0.3;margin-bottom:8px;font-size: 26px;font-weight: bold;font-family:"+GIM.FONT_NAME,e.floorLabel.style.cssText="margin:0;position:absolute;left:2px;top:2px;line-height:22px",e.floorCurLabel.style.cssText="font-size: 16px;font-weight: normal;position:absolute;bottom:2px;left:2px;margin:0;",e.floorLogoImage.style.cssText="width:100%;position:absolute;top:22px;left:2px;",e.floorLabel.innerHTML=a.substr(5,1)+"F",e.floorCurLabel.innerHTML=c?"当前楼层":"目标楼层",e.floorLogoImage.src=b,e.container.name=a,e.container.addEventListener("mousedown",function(a){var b=a.currentTarget.name;d([b])})}function y(){F=new Stats,F.domElement.style.cssText+="position:absolute;top:0px",a.appendChild(F.domElement)}function z(){requestAnimationFrame(z),Q&&(I.rotation.z+=.05*(S-I.rotation.z),F.update());for(var a=0;a<X.length;a++){X[a]}E.render(G,H),TWEEN.update()}var A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q=!1,R=!1,S=0,T=0,U=0,V=0,W=[],X=[],Y={},Z=null,$=null,_={},ab=[],bb=-4200,cb=1200,db=!1,eb=[],fb=0,gb=60,hb=25,ib=[],jb=null,kb={_radian:0,_distance:0,_posX:0,set radian(a){this._radian=a,this.setCamera(this._radian,this._distance,this._posX)},get radian(){return this._radian},set distance(a){this._distance=a,this.setCamera(this._radian,this._distance,this._posX)},get distance(){return this._distance},set posX(a){this._posX=a,this.setCamera(this._radian,this._distance,this._posX)},get posX(){},setCamera:function(a,b,c){this._radian!==a&&(this._radian=a),this._distance!==b&&(this._distance=b),this._posX!==c&&(this._posX=c);var d=Math.cos(a)*b,e=Math.sin(a)*b+GIM.MAP_OFFSET_Y;H.position.set(this._posX,-e,d),H.rotation.x=a}};t()};