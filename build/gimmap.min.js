var GIM={VERSION:"0.0.1",INFO:" *** Author:bob / http://bobliaos.diandian.com / FOR LOVE AND PEACE ***",_map:null,_mapInstance:null,set mapInstance(a){throw new Error("THE MAP INSTANCE CAN'T BE SET!!!")},get mapInstance(){return null===this._mapInstance&&(console.log("- [GimMap]GIM.VERSION:",this.VERSION,this.INFO),this._mapInstance=document.createElement("div"),this._mapInstance.style.cssText="width: 1040px;height: 1440px;overflow: hidden;position: absolute;background:#000000",this._map=new GIM.Map3D(this._mapInstance)),this._mapInstance},goDetail:function(){},navitateTo:function(){},setSize:function(a,b){this._map.setSize(a,b)}};GIM.NODE_TYPE_ASTAR="0",GIM.NODE_TYPE_GROUND="1",GIM.NODE_TYPE_SHOP="2",GIM.NODE_TYPE_MACHINE="3",GIM.NODE_TYPE_ESCALATOR="4",GIM.NODE_TYPE_LIFT="5",GIM.NODE_TYPE_STAIRS="6",GIM.NODE_TYPE_TOILET="7",GIM.NODE_TYPE_SERVICE="8",GIM.NODE_TYPE_ATM="9",GIM.SERVER="192.168.1.208:3000",GIM.MACHINE_NODE_ID="node_2014_8_13_01:18:25_578",GIM.FLOOR_GAP=700,GIM.PATH_POINT_GAP=12,GIM.PATH_COLOR=16711680,GIM.MAP_OFFSET_Y=200,GIM.MAP_BACKGROUND_COLOR=14540253,GIM.SELECTED_COLOR=16759552,GIM.FONT_NAME="Microsoft Yahei",GIM.SHADOW_MAP_SIZE=2048,GIM.CONFIG_URL="map.conf",GIM.DATA_SOURCE_URL="assets/data.sgxml",GIM.SHOP_LIST_URL="assets/shoplist.json",GIM.DEFAULT_SHOP_LOGO_URL="assets/img/shoplogo/0.png",GIM.FloorLogos=function(a){var b={pin:doucment.createElement("canvas")};return pin.width=300,pin.height=300,pin.style.cssText="width:"+pin.width+"px;height:"+pin.height+"px;position:absolute;",pin.id="pinCanvas",a.appendChild(b.pin),b},GIM.MapPin=function(a){var b={width:180,height:160,pinRadius:42,maxRadius:86,container:document.createElement("div"),menuCanvas:document.createElement("canvas"),pinCanvas:document.createElement("canvas"),logoCanvas:document.createElement("canvas"),logoImage:new Image,gotoImage:new Image,searchImage:new Image,init:function(){a.appendChild(this.container),this.container.appendChild(this.menuCanvas),this.container.appendChild(this.pinCanvas),this.container.appendChild(this.logoCanvas),this.container.appendChild(this.gotoImage),this.container.appendChild(this.searchImage),this.container.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;display:none;",this.menuCanvas.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;",this.menuCanvas.width=this.width,this.menuCanvas.height=this.height,this.pinCanvas.style.cssText="width:"+this.width+"px;height:"+this.height+"px;position:absolute;top:0px;left:0px;",this.pinCanvas.width=this.width,this.pinCanvas.height=this.height,this.logoCanvas.width=90,this.logoCanvas.height=90,this.logoCanvas.cssText="width:82px;height:82px",this.pinCanvas.id="pinCanvas",this.logoCanvas.id="logoCanvas",this.gotoImage.id="gotoImage",this.searchImage.id="searchImage",this.logoImage.bindPin=this,this.logoImage.onload=function(a){var b=.5*(this.bindPin.width-a.currentTarget.naturalWidth),c=.5*(this.bindPin.height-a.currentTarget.naturalHeight);this.bindPin.logoCanvas.style.cssText="width:90px;height:90px;position:absolute;top:"+c+"px;left:"+b+"px;display:block",this.bindPin.updateDisplay()},this.gotoImage.src="assets/img/mappin/goto.png",this.gotoImage.style.cssText="top: 20px;position: absolute;left: 96px;",this.searchImage.src="assets/img/mappin/search.png",this.searchImage.style.cssText="top: 56px;position: absolute;left: 132px;"},_isOpenning:!1,open:function(a,b,c){this._isOpenning=!0,c=""===c?GIM.DEFAULT_SHOP_LOGO_URL:"http://"+c,this.logoImage.src=c,console.log("- [GimMap]MapPin.open:",c,this.logoImage.src),this.container.style.display="block",this.container.style.left=a-.5*this.width+"px",this.container.style.top=b-this.height+"px",TWEEN.remove(this),TWEEN.remove(this.gotoImage.style),TWEEN.remove(this.searchImage.style),this.radius=10,this.alpha=.3,this.rotation=0,this.gotoImage.style.display=this.searchImage.style.display="none",this.gotoImage.style.opacity=this.searchImage.style.opacity=0,new TWEEN.Tween(this).to({alpha:1,rotation:0,radius:this.maxRadius},500).easing(TWEEN.Easing.Elastic.Out).onComplete(function(){this.gotoImage.style.opacity=this.searchImage.style.opacity=0,this.gotoImage.style.display=this.searchImage.style.display="block",new TWEEN.Tween(this.gotoImage.style).to({opacity:1},200).start(),new TWEEN.Tween(this.searchImage.style).to({opacity:1},200).start()}).start()},close:function(){this._isOpenning=!1,this.logoImage.src="",this.logoCanvas.style.display="none",this.gotoImage.style.opacity=this.searchImage.style.opacity=0,new TWEEN.Tween(this).to({alpha:0,rotation:0,radius:10},400).easing(TWEEN.Easing.Back.In).onComplete(function(){this._isOpenning||(this.container.style.display="none")}).start()},_radius:100,set radius(a){this._radius=a>this.maxRadius?this.maxRadius:a,this.updateDisplay()},get radius(){return this._radius},_rotation:0,set rotation(a){this._rotation=a,this.updateDisplay()},get rotation(){return this._rotation},_alpha:0,set alpha(a){this._alpha=a,this.updateDisplay()},get alpha(){return this._alpha},updateDisplay:function(){var a=this.menuCanvas.getContext("2d"),b=this.pinCanvas.getContext("2d"),c=this.logoCanvas.getContext("2d");a.clearRect(0,0,this.width,this.height),b.clearRect(0,0,this.width,this.height),c.clearRect(0,0,this.width,this.height);var d=this._radius>this.maxRadius?this.maxRadius:this._radius;d=0>d?0:d,b.strokeStyle="rgba(255,255,255,"+this._alpha+")",b.lineWidth=4,b.fillStyle="rgba(195,13,35,"+this._alpha+")",b.lineCap="round",b.beginPath();var e=.5*this.width,f=this.height-this._radius+20;f<.5*this.height+20&&(f=.5*this.height+20);var g=this.height-b.lineWidth,h=d>this.pinRadius?this.pinRadius:d;if(b.moveTo(e,g),b.arc(e,f,h,.63*Math.PI,.37*Math.PI),b.lineTo(e,g),b.stroke(),b.fill(),b.closePath(),d>this.pinRadius+10){{8*Math.PI/180}a.strokeStyle="rgba(255,255,255,"+this._alpha+")",a.lineWidth=4,a.fillStyle="rgba(235,97,104,"+this._alpha+")";var i=.5*this.width,j=.5*this.height+20;a.beginPath(),a.moveTo(i,j),a.arc(i,j,d,.5*-Math.PI,.254*-Math.PI),a.lineTo(i,j),a.moveTo(i,j),a.arc(i,j,d,.246*-Math.PI,0),a.lineTo(i,j),a.closePath(),a.stroke(),a.fill()}var k=1;this.pinRadius>this._radius&&(k=this._radius/this.pinRadius);try{this.logoCanvas.style.top=f-this.pinRadius*k+this.pinRadius-.5*this.logoImage.height+1.5+"px";var l=(d>this.pinRadius?this.pinRadius:d)-3;0>l&&(l=0),c.beginPath(),c.arc(.5*this.logoImage.width,l,l,0*Math.PI,2*Math.PI);var m=c.createPattern(this.logoImage,"no-repeat");c.fillStyle=m,c.fill(),c.closePath()}catch(n){console.log("- [GimMap]MapPin Load Image Error!"),this.logoImage.src=GIM.DEFAULT_SHOP_LOGO_URL}}};return b.init(),b},GIM.FloorData=function(a){for(var b={origSVG:a,floorId:a.getAttribute("id"),unitsData:{}},c=a.getElementsByTagName("path"),d=0;d<c.length;d++){var e=c[d],f=new GIM.UnitData(e);f.floorId=b.floorId,b.unitsData[f.nodeId]=f}return b},GIM.UnitData=function(a){var b={origSVG:a,nodeId:a.getAttribute("nodeId"),nodeTypeId:a.getAttribute("nodeTypeId"),bindNodeIds:a.getAttribute("bindNodeIds"),bindShopId:a.getAttribute("bindShopId"),d:a.getAttribute("d"),fill:a.getAttribute("fill"),deep:a.getAttribute("deep"),floorId:null,shopName:"",origZ:0},c=a.getAttribute("nodePosition").split(",");b.nodePosition={x:parseFloat(c[0]),y:parseFloat(c[1])},b.selectable=!0,b.astarNode=new GIM.AStarNode(b);for(var d=0;d<GIM.shopList.length;d++){var e=GIM.shopList[d];if(e.shop_room===b.bindShopId){b.shopName=e.name;break}}return b},GIM.SVGParser={loadURL:function(a,b){console.log("- [GimMap]SVGParser.loadURL >>> ",a);var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=c.responseText;b(a)}},c.open("GET",a,!1),c.send(null)},getSVGObject:function(a){var b=new DOMParser;return b.parseFromString(a,"text/xml")},parse:function(a){function b(){for(var b,c,d,k=!1;q>p&&(c=a.charCodeAt(p),c===g||c===h);)p++;for(b=c===j?p++:p;q>p;)if(c=a.charCodeAt(p),c>=e&&f>=c)p++;else{if(c!==i){d=a.substring(b,p);break}p++,k=!0}return k?parseFloat(d):parseInt(d)}function c(){for(var b;q>p&&(b=a.charCodeAt(p),b===g||b===h);)p++;return b=a.charCodeAt(p),b===j||b>=e&&f>=b}const d=Math.PI/180,e=48,f=57,g=44,h=32,i=46,j=45;var k,l,m,n,o=new THREE.Shape,p=1,q=a.length,r=0,s=0,t=0,u=0,v=null,w=null,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0;for(k=a[0];q>=p;){switch(n=!0,k){case"M":r=b(),s=b(),o.moveTo(r,-s),k="L",v=r,w=s;break;case"m":r+=b(),s+=b(),o.moveTo(r,-s),k="L",v=r,w=s;break;case"Z":break;case"z":n=!1,(r!==v||s!==w)&&o.lineTo(v,-w);break;case"L":case"H":case"V":t="V"===k?r:b(),u="H"===k?s:b(),o.lineTo(t,-u),r=t,s=u;break;case"l":case"h":case"v":t="v"===k?r:r+b(),u="h"===k?s:s+b(),o.lineTo(t,-u),r=t,s=u;break;case"C":x=b(),z=b();case"S":"S"===k&&(x=2*r-y,z=2*s-A),y=b(),A=b(),t=b(),u=b(),o.bezierCurveTo(x,-z,y,-A,t,-u),r=t,s=u;break;case"c":x=r+b(),z=s+b();case"s":"s"===k&&(x=2*r-y,z=2*s-A),y=r+b(),A=s+b(),t=r+b(),u=s+b(),o.bezierCurveTo(x,-z,y,-A,t,-u),r=t,s=u;break;case"Q":x=b(),z=b();case"T":"T"===k&&(x=2*r-x,z=2*s-z),t=b(),u=b(),o.quadraticCurveTo(x,-z,t,-u),r=t,s=u;break;case"q":x=r+b(),z=s+b();case"t":"t"===k&&(x=2*r-x,z=2*s-z),t=r+b(),u=s+b(),o.quadraticCurveTo(x,-z,t,-u),r=t,s=u;break;case"A":B=b(),C=b(),D=b()*d,E=b(),F=b(),t=b(),u=b(),x=Math.cos(D)*(r-t)/2+Math.sin(D)*(s-u)/2,z=-Math.sin(D)*(r-t)/2+Math.cos(D)*(s-u)/2;var G=Math.sqrt((B*B*C*C-B*B*z*z-C*C*x*x)/(B*B*z*z+C*C*x*x));E===F&&(G=-G),y=G*B*z/C,A=G*-C*x/B,l=Math.cos(D)*y-Math.sin(D)*A+(r+t)/2,m=Math.sin(D)*y-Math.cos(D)*A+(s+u)/2;var H=new THREE.Vector2(1,0),I=new THREE.Vector2((x-y)/B,(z-A)/C),J=Math.acos(H.dot(I)/H.length()/I.length());H.x*I.y-H.y*I.x<0&&(J=-J),H.x=(-x-y)/B,H.y=(-z-A)/C;var K=Math.acos(I.dot(H)/I.length()/H.length());I.x*H.y-I.y*H.x<0&&(K=-K),!F&&K>0&&(K-=2*Math.PI),F&&0>K&&(K+=2*Math.PI),o.absarc(l,-m,B,J,J+K,F),r=t,s=u;break;default:console.log(">>>"+k+"<<<")}n&&c()||(k=a[p++])}return o}},GIM.AStar={search:function(a,b,c){function d(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}for(var e in a){var f=a[e];f.f=0,f.g=0,f.h=0,f.closed=!1,f.parent=null}var g=a[b],h=a[c];if(g&&h){var i=[],j=[];for(i.push(g);i.length>0;){var k=i.pop();if(j.push(k),k===h)break;for(var l=0;l<k.bindNodes.length;l++){var m=k.bindNodes[l];j.indexOf(m)<0&&(m.g=d(g,h),m.h=d(m,h),m.f=m.g+m.h,m.parent=k,i.push(m))}i.sort(function(a,b){return a.f<b.f})}}for(var n=[],o=j.pop();o;)n.push(o),o=o.parent;return n}},GIM.AStarGraph=function(){this.nodes=[]},GIM.AStarNode=function(a){return{id:a.nodeId,data:a,x:a.nodePosition.x,y:a.nodePosition.y,f:0,g:0,h:0,parent:null,bindNodes:[]}},GIM.DisplayFloor3D=function(a){this.data=new GIM.FloorData(a),this.subUnit3Ds={},this.mesh=new THREE.Object3D,this.mesh.displayUnit3D=this,console.log("- [GimMap]DisplayFloor3D.constructor:",this.data.floorId,"CONSTRUCTING...");for(var b in this.data.unitsData){var c=this.data.unitsData[b],d=new GIM.DisplayUnit3D(c);d.mesh&&this.mesh.add(d.mesh),this.subUnit3Ds[c.nodeId]=d}return this},GIM.DisplayUnit3D=function(a){function b(){var b=GIM.SVGParser.parse(a.d),c=b.toShapes(!0)[0].extrude({amount:1*a.deep,bevelEnabled:!1}),d=new THREE.Color(a.fill),f=new THREE.MeshLambertMaterial({color:d,ambient:d,emissive:d});e=new THREE.Mesh(c,f)}function c(b,c){var d=c?60:80,g=new THREE.PlaneGeometry(d,d,1,1),h=THREE.ImageUtils.loadTexture(b),i=new THREE.MeshBasicMaterial({map:h,transparent:!0}),j=new THREE.Mesh(g,i);j.isServiceLogo=c,e?e.add(j):e=j,j.castShadow=!0,j.receiveShadow=!0,j.position.x=a.nodePosition.x,j.position.y=-a.nodePosition.y+(c?0:.5*d),j.position.z=parseInt(a.deep)+f,j.rotation.x=.25*Math.PI,c&&(a.origZ=50,j.position.z=a.origZ)}function d(b,c,d){if(""!=b){void 0===c&&(c=0),void 0===d&&(d=18);var g=d+"px "+GIM.FONT_NAME,h=document.createElement("canvas"),i=h.getContext("2d");i.font=g,h.width=i.measureText(b).width+2,h.height=24,h.style.cssText="width:"+h.width+"px;height:"+h.height+"px;background:#FF0000;margin:2px;",i.font=g,i.fillStyle="#000",i.fillText(b,1,h.height-6);var j=new THREE.PlaneGeometry(h.width,h.height,1,1),k=new THREE.Texture(h);k.needsUpdate=!0;var l=new THREE.MeshBasicMaterial({map:k,transparent:!0}),m=new THREE.Mesh(j,l);m.position.x=a.nodePosition.x,m.position.y=-a.nodePosition.y-c-.5*h.height,m.position.z=parseInt(a.deep)+f,e?e.add(m):e=m}}var e=null,f=10;switch(a.nodeTypeId){case GIM.NODE_TYPE_ASTAR:break;case GIM.NODE_TYPE_GROUND:b(),a.selectable=!1,e.position.z=-(1*a.deep+1);break;case GIM.NODE_TYPE_SHOP:b(),a.bindShopId&&(d(a.shopName),d(a.bindShopId,18,14));break;case GIM.NODE_TYPE_MACHINE:c("assets/img/nodetypelogo/machine.png",!0);break;case GIM.NODE_TYPE_ESCALATOR:c("assets/img/nodetypelogo/escalator.png",!0);break;case GIM.NODE_TYPE_LIFT:c("assets/img/nodetypelogo/lift.png",!0);break;case GIM.NODE_TYPE_TOILET:c("assets/img/nodetypelogo/toilet.png",!0);break;case GIM.NODE_TYPE_SERVICE:c("assets/img/nodetypelogo/service.png",!0);break;case GIM.NODE_TYPE_ATM:c("assets/img/nodetypelogo/atm.png",!0)}return e&&(e.castShadow=!0,e.receiveShadow=!0,this.mesh=e,this.mesh.displayUnit3D=this),this.data=a,this},GIM.Map3D=function(a){function b(a){if(k(a),W){console.log("- [GimMap]Map3D.navigateTo Shop",W.data.bindShopId);var b=Y[GIM.MACHINE_NODE_ID].data.floorId,e=W.data.floorId;c(b===e?[b]:[b,e]);for(var g=[],h=GIM.AStar.search(Y,GIM.MACHINE_NODE_ID,W.data.nodeId),i=0;i<h.length;i++){var j=h[i],l=V[j.data.floorId],m=new THREE.Vector3(j.x,j.y,l.mesh.position.z+5);g.push(m)}f(g),d(W)}}function c(a){null===X&&(X=a),L._isOpenning&&L.close(),console.log("- [GimMap]Map3D.showFloors:",a.toString());for(var b=0;b<Z.length;b++){var c=Z[b];c.selected=!1,a.indexOf(Z[b].id)>-1&&(c.selected=!0)}for(var d in V){var e=V[d];e.mesh.visible=!1,e.mesh.position.z=$}if(1===a.length){if(X.length>0){var f=X[0],g=a[0],h=V[f],i=V[g];if(i.mesh.visible=h.mesh.visible=!0,h!==i){var j=parseInt(f.substr(5,1))>parseInt(g.substr(5,1));h.mesh.position.z=0,i.mesh.position.z=j?$:_,new TWEEN.Tween(h.mesh.position).to({z:j?_:$},800).easing(TWEEN.Easing.Exponential.Out).start(),new TWEEN.Tween(i.mesh.position).to({z:0},800).easing(TWEEN.Easing.Exponential.Out).start()}else h.mesh.position.z=0}}else if(2===a.length){var k=V[a[0]],l=V[a[1]];k.mesh.visible=l.mesh.visible=!0;var j=parseInt(k.data.floorId.substr(5,1))>parseInt(l.data.floorId.substr(5,1));k.mesh.position.z=.5*GIM.FLOOR_GAP*(j?1:-1),l.mesh.position.z=.5*GIM.FLOOR_GAP*(j?-1:1)}X=a}function d(a){if(null!==a){var b=o(a.data.nodePosition.x,-a.data.nodePosition.y,a.mesh.parent.position.z+parseInt(a.data.deep)+20);L.open(b.x,b.y,p(a.data.bindShopId))}}function e(a){for(var b=0;b<X.length;b++){var c=V[X[b]];for(var d in c.subUnit3Ds){var e=c.subUnit3Ds[d];e.data.nodeTypeId===a&&(e.mesh.material.opacity=0,e.mesh.scale.x=e.mesh.scale.y=1.2,new TWEEN.Tween(e.mesh.material).to({opacity:1},600).easing(TWEEN.Easing.Back.InOut).repeat(2).start(),new TWEEN.Tween(e.mesh.scale).to({x:1,y:1},600).easing(TWEEN.Easing.Elastic.InOut).repeat(2).start())}}}function f(a){a=j(a);for(var b,c=new THREE.Geometry,d=0;d<a.length;d++)b=a[d],c.vertices[d]=new THREE.Vector3(b.x,-b.y,b.z);K=new THREE.Line(c,new THREE.LineBasicMaterial({color:GIM.PATH_COLOR})),K.visible=O;for(var d=0;d<c.vertices.length;d++){var e=c.vertices[d];if(!c.vertices[d+1]||c.vertices[d].z===c.vertices[d+1].z||d%2==0){var f=new THREE.CircleGeometry(bb,8),g=new THREE.MeshBasicMaterial({color:GIM.PATH_COLOR}),h=new THREE.Mesh(f,g);H.add(h),ab.push(h),h.position.x=e.x,h.position.y=e.y,h.position.z=e.z+15}}H.add(K)}function g(){cb++,cb>eb&&(cb=0);for(var a=0;a<ab.length;a++){var b=ab[a];b.scale.x=b.scale.y=1-(a+cb)%eb/eb,b.scale.x<.3&&(b.scale.x=b.scale.y=1)}}function h(){for(K&&(K.parent.remove(K),K=null,delete K);ab.length>0;){var a=ab.pop();a&&(a.parent.remove(a),a=null,delete a)}}function i(a,b){console.log("- [GimMap]Map3D.setSize:",a,b),z=a,A=b,B=.5*z,C=.5*A,G.aspect=z/A,G.updateProjectionMatrix(),D.setSize(z,A)}function j(a){for(var b=[],c=null,d=0;d<a.length;d++){var e=a[d];if(c){b.push(c);var f=e.clone().sub(c),g=f.length();if(g>GIM.PATH_POINT_GAP)for(var h=parseInt(g/GIM.PATH_POINT_GAP),i=1;h>i;i++)b.push(f.clone().multiplyScalar(i/h).add(c))}c=e}return b}function k(a){n();for(var b in V){var c=V[b];for(var d in c.subUnit3Ds){var e=c.subUnit3Ds[d];if(a===e.data.bindShopId){console.log("- [GimMap]Map3D.selectUint3DByShopId:",a,"DONE!"),m(e);break}}}}function l(a,b){n(),a=2*a/z-1,b=1-2*b/A;var c=new THREE.Vector3(a,b,0);I.unprojectVector(c,G);var d=new THREE.Raycaster(G.position,c.sub(G.position).normalize()),e=d.intersectObjects(T);if(e.length>0){var f=e[0].object;f.displayUnit3D&&f.displayUnit3D.data.selectable&&(console.log("- [GimMap]Map3D.selectUnit3DByPosition",f.displayUnit3D.data.nodeId),m(f.displayUnit3D))}}function m(a){if(W=a,a.mesh.isServiceLogo){for(var b=0;b<U.length;b++){var c=U[b];new TWEEN.Tween(c.position).to({z:a.data.origZ},500).easing(TWEEN.Easing.Elastic.Out).start()}new TWEEN.Tween(a.mesh.position).to({z:a.data.origZ+20},500).easing(TWEEN.Easing.Elastic.Out).start()}else{fb=W.mesh.material;var d=new THREE.Color(W.data.fill);d.add(new THREE.Color(3355443)),W.mesh.material=new THREE.MeshLambertMaterial({color:d,ambient:d,emissive:d})}new TWEEN.Tween(a.mesh.scale).to({z:1.4,x:a.mesh.isServiceLogo?1.1:1,y:a.mesh.isServiceLogo?1.1:1},500).easing(TWEEN.Easing.Elastic.Out).start()}function n(){null!==W&&(null===fb||W.mesh.isServiceLogo||(W.mesh.material=fb),new TWEEN.Tween(W.mesh.scale).to({z:1,x:1,y:1},500).easing(TWEEN.Easing.Elastic.Out).start(),W=null)}function o(a,b,c){var d=new THREE.Projector,e=new THREE.Vector3(a+H.position.x,b,c),f=d.projectVector(e,G);return{x:Math.round(f.x*B+B),y:Math.round(-f.y*C+C)}}function p(a){var b="";if(GIM.shopList)for(var c=0;c<GIM.shopList.length;c++){var d=GIM.shopList[c];d.shop_room.toString()===a&&(console.log("- [GimMap]Map3D.getShopLogoURL:",a),b=GIM.SERVER+"/system"+d.shop_logo)}return b}function q(e){if(e.preventDefault(),a.addEventListener("mousemove",r,!1),a.addEventListener("mouseup",s,!1),a.addEventListener("mouseout",s,!1),h(),L.close(),"gotoImage"===e.target.id&&e.offsetY<L.width)W&&(console.log("- [GimMap]Map3D.onContainerMouseDown ShopId:",W.data.bindShopId),W.data.nodeTypeId===GIM.NODE_TYPE_SHOP&&b(W.data.bindShopId));else if("searchImage"===e.target.id)console.log("- [GimMap]Map3D.goDetail:",W.data.bindShopId),GIM.goDetail(W.data.bindShopId);else if(l(e.offsetX,e.offsetY),W)if(W.data.nodeTypeId===GIM.NODE_TYPE_SHOP)d(W);else{console.log("- [GimMap]Map3D.navigateTo Shop",W.data.bindShopId);var g=Y[GIM.MACHINE_NODE_ID].data.floorId,i=W.data.floorId;c(g===i?[g]:[g,i]);for(var j=[],k=GIM.AStar.search(Y,GIM.MACHINE_NODE_ID,W.data.nodeId),m=0;m<k.length;m++){var n=k[m],o=n.data.floorId,p=V[o],q=new THREE.Vector3(n.x,n.y,p.mesh.position.z+5);j.push(q)}f(j)}}function r(a){R=a.clientX-B,P=Q+.02*(R-S)}function s(){a.removeEventListener("mousemove",r,!1),a.removeEventListener("mouseup",s,!1),a.removeEventListener("mouseout",s,!1)}function t(){GIM.SVGParser.loadURL(GIM.SHOP_LIST_URL,function(c){GIM.shopList=JSON.parse(c),GIM.navitateTo=b,GIM.setSize=i,u(),O&&x(),a.addEventListener("mousedown",q,!1),y(),setInterval(g,db)})}function u(){var b=1,d=1e4;D=new THREE.WebGLRenderer({antialias:!0}),a.appendChild(D.domElement),D.setClearColor(GIM.MAP_BACKGROUND_COLOR),D.setSize(64,64),D.shadowMapEnabled=!0,D.shadowMapType=THREE.PCFShadowMap,F=new THREE.Scene,G=new THREE.PerspectiveCamera(60,1,b,d),H=new THREE.Object3D,F.add(H),i(parseFloat(a.style.width),parseFloat(a.style.height));var e=new THREE.DirectionalLight(0,0);F.add(e),e.position.set(1400,-2200,2200),e.target.position.set(500,-300,0),e.castShadow=!0,e.shadowCameraNear=1800,e.shadowCameraFar=4500,e.shadowBias=1e-4,e.shadowDarkness=.6,e.shadowMapWidth=e.shadowMapHeight=GIM.SHADOW_MAP_SIZE,O&&(e.shadowCameraVisible=!0);var f=new THREE.DirectionalLight(3355443,1);if(F.add(f),f.position.set(400,500,400),O){var g=new THREE.Mesh(new THREE.PlaneGeometry(5e3,5e3,50,50),new THREE.MeshBasicMaterial({color:15658734,wireframe:!0}));H.add(g)}I=new THREE.Projector,L=new GIM.MapPin(a),GIM.SVGParser.loadURL(GIM.DATA_SOURCE_URL,function(a){v(),J=GIM.SVGParser.getSVGObject(a);for(var b=J.getElementsByTagName("g"),d=b.length-1;d>=0;d--){var e=b[d],f=new GIM.DisplayFloor3D(e);V[f.data.floorId]=f,H.add(f.mesh);for(var g in f.subUnit3Ds){var h=f.subUnit3Ds[g].mesh;h&&(T.push(h),h.isServiceLogo&&U.push(h))}var i=!1;for(var g in f.data.unitsData){var j=f.data.unitsData[g];Y[j.nodeId]=j.astarNode,j.nodeId===GIM.MACHINE_NODE_ID&&(i=!0)}w(f.data.floorId,"assets/img/floorlogo/"+f.data.floorId+".png",i)}for(var k in Y){var l=Y[k],m=l.data.bindNodeIds,n=m.split(",");for(var o in n){var p=n[o],q=Y[p];q&&l.bindNodes.push(q)}}c([Y[GIM.MACHINE_NODE_ID].data.floorId]),gb.setCamera(.25*Math.PI,1800,0),gb.posX=.5*parseFloat(J.getElementsByTagName("svg")[0].getAttribute("width"))-100})}function v(){M=document.createElement("div"),a.appendChild(M),M.style.cssText="position:absolute;top:240px;left:0px",N=document.createElement("div"),a.appendChild(N),N.style.cssText="position:absolute;top:30px;left:240px";for(var b=["assets/img/servicelogo/1.png","assets/img/servicelogo/2.png","assets/img/servicelogo/3.png","assets/img/servicelogo/4.png","assets/img/servicelogo/5.png","assets/img/servicelogo/6.png"],c=[GIM.NODE_TYPE_MACHINE,GIM.NODE_TYPE_SERVICE,GIM.NODE_TYPE_ATM,GIM.NODE_TYPE_TOILET,GIM.NODE_TYPE_ESCALATOR,GIM.NODE_TYPE_LIFT],d=0;d<b.length;d++){var f=new Image;N.appendChild(f),f.style.cssText="position:absolute;left:"+100*d+"px",f.nodeTypeId=c[d],f.src=b[d],f.onclick=function(a){e(a.target.nodeTypeId);var b=a.target;TWEEN.remove(b),b.style.opacity=0,new TWEEN.Tween(b.style).to({opacity:1},300).easing(TWEEN.Easing.Exponential.InOut).start()}}}function w(a,b,d){var e={id:a,width:170,height:120,container:document.createElement("div"),floorLabel:document.createElement("p"),floorCurLabel:document.createElement("p"),floorLogoImage:new Image,_selected:!1,set selected(a){this._selected=a,this.container.style.opacity=a?1:.4,this.container.style.border=a?"1px dashed #FF0033":"1px dashed #AAAAAA",this.container.style.color=a?"#FF0033":"#222222",this.floorCurLabel.style.display=a?"block":"none",TWEEN.remove(this),new TWEEN.Tween(this).to({scale:a?1.2:1},300).easing(TWEEN.Easing.Exponential.Out).start()},get selected(){return this._selected},_scale:1,set scale(a){this._scale=a,this.container.style.height=this.height*a+"px",this.container.style.width=this.width*a+"px"},get scale(){return this._scale}};M.appendChild(e.container),Z.push(e),e.container.appendChild(e.floorLabel),e.container.appendChild(e.floorCurLabel),e.container.appendChild(e.floorLogoImage),e.container.style.cssText="position:relative;height:"+e.height+"px;width:"+e.width+"px;opacity:0.3;font-size: 26px;font-weight: bold;font-family:"+GIM.FONT_NAME,e.floorLabel.style.cssText="margin:0;position:absolute;left:2px;top:2px;line-height:22px",e.floorCurLabel.style.cssText="font-size: 20px;font-weight: normal;position:absolute;top:0px;left:40px;margin:0;",e.floorLogoImage.style.cssText="width:100%;position:absolute;top:36px;left:2px;",e.floorLabel.innerHTML=a.substr(5,1)+"F",e.floorCurLabel.innerHTML=d?"当前楼层":"目标楼层",e.floorLogoImage.src=b,e.container.name=a,e.container.addEventListener("mousedown",function(a){var b=a.currentTarget.name;c([b])})}function x(){E=new Stats,E.domElement.style.cssText+="position:absolute;top:0px",a.appendChild(E.domElement)}function y(){requestAnimationFrame(y),O&&(H.rotation.z+=.05*(P-H.rotation.z),E.update());for(var a=0;a<U.length;a++){U[a]}D.render(F,G),TWEEN.update()}var z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O=!1,P=0,Q=0,R=0,S=0,T=[],U=[],V={},W=null,X=null,Y={},Z=[],$=-4200,_=1200,ab=[],bb=4,cb=0,db=60,eb=25,fb=null,gb=(new THREE.MeshLambertMaterial({color:GIM.SELECTED_COLOR,ambient:GIM.SELECTED_COLOR,emissive:GIM.SELECTED_COLOR}),{_radian:0,_distance:0,_posX:0,set radian(a){this._radian=a,this.setCamera(this._radian,this._distance,this._posX)},get radian(){return this._radian},set distance(a){this._distance=a,this.setCamera(this._radian,this._distance,this._posX)},get distance(){return this._distance},set posX(a){this._posX=a,this.setCamera(this._radian,this._distance,this._posX)},get posX(){},setCamera:function(a,b,c){this._radian!==a&&(this._radian=a),this._distance!==b&&(this._distance=b),this._posX!==c&&(this._posX=c);var d=Math.cos(a)*b,e=Math.sin(a)*b+GIM.MAP_OFFSET_Y;G.position.set(this._posX,-e,d),G.rotation.x=a}});GIM.SVGParser.loadURL(GIM.CONFIG_URL,function(a){var b=JSON.parse(a);"undefined"!=typeof b.server&&""!==b.server&&(GIM.SERVER=b.server),"undefined"!=typeof b.machindeNodeId&&""!==b.machindeNodeId&&(GIM.MACHINE_NODE_ID=b.machindeNodeId),"undefined"!=typeof b.shadowRank&&""!==b.shadowRank&&(GIM.SHADOW_MAP_SIZE=1024*parseFloat(b.shadowRank)),"undefined"!=typeof b.sourceSVGURL&&""!==b.sourceSVGURL&&(GIM.DATA_SOURCE_URL=b.sourceSVGURL),"undefined"!=typeof b.sourceShopListURL&&""!==b.sourceShopListURL&&(GIM.SHOP_LIST_URL=b.sourceShopListURL),t()})};